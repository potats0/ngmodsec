use Test::Nginx::Socket 'no_plan';

# 设置测试环境
no_root_location();
no_shuffle();

run_tests();

# 大华智慧园区综合管理平台 devicePoint_addImgIco CVE-2023-3836 任意文件上传漏洞



__DATA__
=== TEST 1: 测试1
--- http_config
    error_log logs/error.log debug;
--- config
        # 精确匹配 /echo 并返回固定响应
        location = /echo {
            return 200 "echo";
        }

        # 处理其他所有请求
        location / {
            error_log logs/error.log debug;

            # 检查是否为内部代理请求
            if ($http_x_internal_proxy = "true") {
                return 200 "echo";
            }

            # 应用自定义规则
            rule 'rule 2003 http.uri contains "emap/devicePoint_addImgIco" and http.method = POST and http.raw_req_body matches "(?i)Content-Disposition:[^\\n]*filename=[\'\\"]?[^\\n\'\\"]*\\.(jsp|jspx|asp|aspx|php|exe|sh)[\'\\"\\n]";';

            # 设置自定义请求头标识内部代理请求
            proxy_set_header X-Internal-Proxy true;

            # 代理请求到 /echo
            proxy_pass http://127.0.0.1:$TEST_NGINX_SERVER_PORT/echo;
        }
--- request
POST /emap/devicePoint_addImgIco?hasSubsystem=true&X-BasTag=ba2698678348
123
--A9-oH6XdEkeyrNu4cNSk-ppZB059oDDT--
--- more_headers
--A9-oH6XdEkeyrNu4cNSk-ppZB059oDDT
Content-Disposition: form-data; name="upload"; filename="test.jsp"
Content-Type: application/octet-stream
Content-Transfer-Encoding: binary

--- error_log
Matched Rule ID: 2003

--- no_error_log
[error]


=== TEST 2: 测试2
--- http_config
    error_log logs/error.log debug;
--- config
        # 精确匹配 /echo 并返回固定响应
        location = /echo {
            return 200 "echo";
        }

        # 处理其他所有请求
        location / {
            error_log logs/error.log debug;

            # 检查是否为内部代理请求
            if ($http_x_internal_proxy = "true") {
                return 200 "echo";
            }

            # 应用自定义规则
            rule 'rule 2004 http.uri contains "upload/emap/society_new" and http.method = GET;';

            # 设置自定义请求头标识内部代理请求
            proxy_set_header X-Internal-Proxy true;

            # 代理请求到 /echo
            proxy_pass http://127.0.0.1:$TEST_NGINX_SERVER_PORT/echo;
        }
--- request
GET upload/emap/society_new/-%3E%7CqaxnbfzUiX0eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb29raWVzIjpbXSwiaGVhZGVycyI6IiIsIm1ldGhvZCI6IlBPU1QiLCJwYXRoIjoiL2VtYXAvZGV2aWNlUG9pbnRfYWRkSW1nSWNvP2hhc1N1YnN5c3RlbT10cnVlXHUwMDI2WC1CYXNUYWc9YmEyNjk4Njc4MzQ4IiwicG9zdGRhdGEiOiItLUE5LW9INlhkRWtleXJOdTRjTlNrLXBwWkIwNTlvRERUXHJcbkNvbnRlbnQtRGlzcG9zaXRpb246IGZvcm0tZGF0YTsgbmFtZT1cInVwbG9hZFwiOyBmaWxlbmFtZT1cInRlc3QuanNwXCJcclxuQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cclxuQ29udGVudC1UcmFuc2Zlci1FbmNvZGluZzogYmluYXJ5XHJcblxyXG4xMjNcclxuLS1BOS1vSDZYZEVrZXlyTnU0Y05Tay1wcFpCMDU5b0REVC0tIiwicXVlcnlfcGFyYW1zIjp7IlgtQmFzVGFnIjpbImJhMjY5ODY3ODM0OCJdLCJoYXNTdWJzeXN0ZW0iOlsidHJ1ZSJdfSwidXJsIjoiaHR0cDovLzEwOC4yMDEuMTYuMTkyOjI1NTUvZW1hcC9kZXZpY2VQb2ludF9hZGRJbWdJY28_aGFzU3Vic3lzdGVtPXRydWVcdTAwMjZYLUJhc1RhZz1iYTI2OTg2NzgzNDgifQ.aQ9C-TuRtIlKpfegvFYq9aYJAcdKcveeLQo00zaqVtYXf9911skyeyebas%7C%3C-?X-BasTag=ba2698678348

--- more_headers

--- error_log
Matched Rule ID: 2004

--- no_error_log
[error]
